<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;
use Pixelperfect\HyvaCookieConsent\ViewModel\CookieConsent;

/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$hyvaCsp = $viewModels->require(HyvaCsp::class);
$consentViewModel = $viewModels->require(CookieConsent::class);

if (!$consentViewModel->isEnabled()) {
    return;
}

$position = $consentViewModel->getFloatingButtonPosition();
$positionClass = $position === 'right' ? 'right-4' : 'left-4';
?>

<button
    type="button"
    x-data="cookieSettingsButton"
    @click="openSettings"
    data-testid="cookie-settings-button"
    class="fixed bottom-4 <?= $escaper->escapeHtmlAttr($positionClass) ?> z-40 p-3 bg-gray-800 text-white rounded-full shadow-lg hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Cookie Settings')) ?>"
    title="<?= $escaper->escapeHtmlAttr(__('Cookie Settings')) ?>"
>
    <!-- Cookie SVG Icon -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="8" cy="9" r="1.5" fill="currentColor"/>
        <circle cx="15" cy="8" r="1" fill="currentColor"/>
        <circle cx="10" cy="14" r="1" fill="currentColor"/>
        <circle cx="16" cy="13" r="1.5" fill="currentColor"/>
        <circle cx="13" cy="17" r="1" fill="currentColor"/>
    </svg>
</button>

<script>
    'use strict';

    function initCookieSettingsButton() {
        return {
            openSettings() {
                window.dispatchEvent(new CustomEvent('open-cookie-settings'));
            }
        };
    }

    document.addEventListener('alpine:init', () => {
        Alpine.data('cookieSettingsButton', initCookieSettingsButton);
    }, { once: true });
</script>
<?php $hyvaCsp->registerInlineScript() ?>
