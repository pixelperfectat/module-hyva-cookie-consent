<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Pixelperfect\HyvaCookieConsent\ViewModel\CookieConsent;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var ViewModelRegistry $viewModels */

$consentViewModel = $viewModels->require(CookieConsent::class);

if (!$consentViewModel->isEnabled()) {
    return;
}

$enabledServices = $consentViewModel->getEnabledServices();
?>

<?php foreach ($enabledServices as $service): ?>
    <?php
    $template = $service->getTemplate();
    if (!empty($template)):
        // Render the service template as a child block
        echo $block->getLayout()
            ->createBlock(Template::class)
            ->setTemplate($template)
            ->setData('service', $service)
            ->setData('view_models', $viewModels)
            ->toHtml();
    endif;
    ?>
<?php endforeach; ?>
