<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Pixelperfect\HyvaCookieConsent\ViewModel\CookieConsent;

/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$consentViewModel = $viewModels->require(CookieConsent::class);

if (!$consentViewModel->isEnabled()) {
    return;
}

$categories = $consentViewModel->getCategories();
$bannerStyle = $consentViewModel->getBannerStyle();

// Determine wrapper classes based on banner style
$wrapperClasses = $bannerStyle === 'modal'
    ? 'fixed inset-0 z-50 flex items-center justify-center bg-black/50'
    : 'fixed bottom-0 left-0 right-0 z-50 bg-white shadow-lg border-t';

$containerClasses = $bannerStyle === 'modal'
    ? 'bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto'
    : 'container mx-auto p-4';
?>

<!-- CSP Strict: x-data WITHOUT parentheses -->
<section
    id="cookie-consent-banner"
    x-data="hyvaCookieConsent"
    x-cloak
    x-show="showBanner"
    x-transition
    class="<?= $escaper->escapeHtmlAttr($wrapperClasses) ?>"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Cookie Consent')) ?>"
    role="dialog"
    aria-modal="true"
>
    <div class="<?= $escaper->escapeHtmlAttr($containerClasses) ?>">
        <!-- Header -->
        <div class="p-6 border-b">
            <h2 class="text-xl font-bold text-gray-900">
                <?= $escaper->escapeHtml($consentViewModel->getBannerHeadline()) ?>
            </h2>
            <p class="mt-2 text-gray-600">
                <?= $escaper->escapeHtml($consentViewModel->getBannerDescription()) ?>
                <a href="<?= $escaper->escapeUrl($consentViewModel->getPrivacyPolicyUrl()) ?>"
                   class="text-primary underline hover:no-underline">
                    <?= $escaper->escapeHtml(__('Privacy Policy')) ?>
                </a>
            </p>
        </div>

        <!-- Category Toggles (shown when showDetails is true) -->
        <div class="p-6 space-y-4" x-show="showDetails" x-transition>
            <?php foreach ($categories as $category): ?>
            <div class="border rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex-1 pr-4">
                        <h3 class="font-semibold text-gray-900">
                            <?= $escaper->escapeHtml(__($category->getTitle())) ?>
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">
                            <?= $escaper->escapeHtml(__($category->getDescription())) ?>
                        </p>
                    </div>
                    <?php if ($category->isRequired()): ?>
                    <span class="text-sm text-gray-400 italic whitespace-nowrap">
                        <?= $escaper->escapeHtml(__('Always Active')) ?>
                    </span>
                    <?php else: ?>
                    <button
                        type="button"
                        @click="toggleCategoryClick"
                        data-category="<?= $escaper->escapeHtmlAttr($category->getCode()) ?>"
                        class="toggle-switch relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                        :class="{ 'is-active': consent.<?= $escaper->escapeJs($category->getCode()) ?> }"
                        role="switch"
                        :aria-checked="consent.<?= $escaper->escapeJs($category->getCode()) ?>"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Toggle %1', __($category->getTitle()))) ?>"
                    >
                        <span
                            class="toggle-knob pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out mt-0.5 ml-0.5"
                            :class="{ 'is-active': consent.<?= $escaper->escapeJs($category->getCode()) ?> }"
                        ></span>
                    </button>
                    <?php endif; ?>
                </div>

                <!-- Cookie details expandable -->
                <?php $services = $consentViewModel->getServicesForCategory($category->getCode()); ?>
                <?php if (!empty($services)): ?>
                <div class="mt-3 pt-3 border-t text-sm" x-show="showCookieDetails" x-transition>
                    <?php foreach ($services as $service): ?>
                    <div class="mb-3 last:mb-0">
                        <span class="font-medium text-gray-700">
                            <?= $escaper->escapeHtml(__($service->getTitle())) ?>
                        </span>
                        <?php if ($service->getManagedBy()): ?>
                        <span class="text-xs text-gray-400 ml-1">
                            (<?= $escaper->escapeHtml(__('via %1', $service->getManagedBy())) ?>)
                        </span>
                        <?php endif; ?>
                        <p class="text-gray-500 text-xs mt-0.5">
                            <?= $escaper->escapeHtml(__($service->getDescription())) ?>
                        </p>
                        <?php $cookies = $service->getCookies(); ?>
                        <?php if (!empty($cookies)): ?>
                        <ul class="text-xs text-gray-400 ml-4 mt-1 list-disc">
                            <?php foreach ($cookies as $cookie): ?>
                            <li>
                                <code class="bg-gray-100 px-1 rounded"><?= $escaper->escapeHtml($cookie['name'] ?? '') ?></code>
                                - <?= $escaper->escapeHtml(__($cookie['description'] ?? '')) ?>
                                <span class="text-gray-300">(<?= $escaper->escapeHtml($cookie['duration'] ?? '') ?>)</span>
                            </li>
                            <?php endforeach; ?>
                        </ul>
                        <?php endif; ?>
                    </div>
                    <?php endforeach; ?>
                </div>
                <?php endif; ?>
            </div>
            <?php endforeach; ?>

            <button
                type="button"
                @click="toggleCookieDetails"
                data-testid="cookie-show-details"
                class="text-sm text-primary underline hover:no-underline"
            >
                <span x-show="!showCookieDetails"><?= $escaper->escapeHtml(__('Show cookie details')) ?></span>
                <span x-show="showCookieDetails"><?= $escaper->escapeHtml(__('Hide cookie details')) ?></span>
            </button>
        </div>

        <!-- Actions -->
        <div class="p-6 border-t bg-gray-50 flex flex-wrap gap-3 justify-end">
            <button
                type="button"
                @click="toggleDetails"
                data-testid="cookie-customize"
                class="btn btn-secondary px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100 transition-colors"
            >
                <span x-show="!showDetails"><?= $escaper->escapeHtml(__('Customize')) ?></span>
                <span x-show="showDetails"><?= $escaper->escapeHtml(__('Back')) ?></span>
            </button>
            <button
                type="button"
                @click="rejectAll"
                data-testid="cookie-reject-all"
                class="btn btn-secondary px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-100 transition-colors"
            >
                <?= $escaper->escapeHtml(__('Reject All')) ?>
            </button>
            <template x-if="showDetails">
                <button
                    type="button"
                    @click="savePreferences"
                    data-testid="cookie-save-preferences"
                    class="btn btn-primary px-4 py-2 bg-primary text-white rounded hover:bg-primary-darker transition-colors"
                >
                    <?= $escaper->escapeHtml(__('Save Preferences')) ?>
                </button>
            </template>
            <template x-if="!showDetails">
                <button
                    type="button"
                    @click="acceptAll"
                    data-testid="cookie-accept-all"
                    class="btn btn-primary px-4 py-2 bg-primary text-white rounded hover:bg-primary-darker transition-colors"
                >
                    <?= $escaper->escapeHtml(__('Accept All')) ?>
                </button>
            </template>
        </div>
    </div>
</section>
