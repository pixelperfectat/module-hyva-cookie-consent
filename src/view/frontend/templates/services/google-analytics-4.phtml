<?php

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Pixelperfect\HyvaCookieConsent\ViewModel\CookieConsent;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var ViewModelRegistry $viewModels */

// Get ViewModel from layout XML argument or fallback to view_models registry
$consentViewModel = $block->getData('view_model');
if (!$consentViewModel instanceof CookieConsent) {
    $viewModels = $block->getData('view_models');
    $consentViewModel = $viewModels ? $viewModels->require(CookieConsent::class) : null;
}

if (!$consentViewModel) {
    return;
}

$hyvaCsp = $viewModels->require(HyvaCsp::class);

// Get service from ServicePool
$service = $consentViewModel->getServicePool()->getService('google_analytics_4');
if (!$service || !$service->isEnabled()) {
    return;
}

$measurementId = $service->getConfigValue('measurement_id');

if (empty($measurementId)) {
    return;
}

$category = $service->getCategory();
?>

<!-- Google Analytics 4 - Blocked until consent -->
<script type="text/plain"
        data-consent-category="<?= $escaper->escapeHtmlAttr($category) ?>"
        data-consent-src="https://www.googletagmanager.com/gtag/js?id=<?= $escaper->escapeUrl($measurementId) ?>">
</script>

<template data-consent-category="<?= $escaper->escapeHtmlAttr($category) ?>">
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '<?= $escaper->escapeJs($measurementId) ?>', {
            'anonymize_ip': true
        });
    </script>
</template>
